<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Analyzing Ceph Network Module 3">
<meta itemprop="description" content="High level Ceph architecture. [src]
  In the previous posts 1 2, I illustrated how we establishes a connection between a server and a client using AsyncMessenger functions.
However, in high level Ceph architecture, there are some more abstracted APIs that are useful for specific purpose, e.g., accessing ceph-mon or ceph-osd, etc. This post illustrates how MonClient is implemented.
MonClient MonClient, considering its name, is a class that can be used to connect a Ceph monitor daemon.">
<meta itemprop="datePublished" content="2020-12-11T15:28:00+09:00" />
<meta itemprop="dateModified" content="2020-12-11T15:28:00+09:00" />
<meta itemprop="wordCount" content="1224">



<meta itemprop="keywords" content="study,ceph," />
<meta property="og:title" content="Analyzing Ceph Network Module 3" />
<meta property="og:description" content="High level Ceph architecture. [src]
  In the previous posts 1 2, I illustrated how we establishes a connection between a server and a client using AsyncMessenger functions.
However, in high level Ceph architecture, there are some more abstracted APIs that are useful for specific purpose, e.g., accessing ceph-mon or ceph-osd, etc. This post illustrates how MonClient is implemented.
MonClient MonClient, considering its name, is a class that can be used to connect a Ceph monitor daemon." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://insujang.github.io/2020-12-11/analyzing-ceph-network-module-3/" />
<meta property="article:published_time" content="2020-12-11T15:28:00+09:00" />
<meta property="article:modified_time" content="2020-12-11T15:28:00+09:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Analyzing Ceph Network Module 3"/>
<meta name="twitter:description" content="High level Ceph architecture. [src]
  In the previous posts 1 2, I illustrated how we establishes a connection between a server and a client using AsyncMessenger functions.
However, in high level Ceph architecture, there are some more abstracted APIs that are useful for specific purpose, e.g., accessing ceph-mon or ceph-osd, etc. This post illustrates how MonClient is implemented.
MonClient MonClient, considering its name, is a class that can be used to connect a Ceph monitor daemon."/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Analyzing Ceph Network Module 3</title>
	<link rel="stylesheet" href="https://insujang.github.io/css/style.min.750dffddfe464fb1deda1889e9da51b10b17d137b71ce3fceea0577e63c622e1.css" integrity="sha256-dQ3/3f5GT7He2hiJ6dpRsQsX0Te3HOP87qBXfmPGIuE=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper container-lg">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://insujang.github.io">Better Tomorrow with Computer Science</a>
				</div>
				<nav class="site-nav d-md-inline d-none">
					
				<a href="https://insujang.github.io/posts/">Posts</a>
				<a href="https://insujang.github.io/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social d-md-inline d-none"><a href="https://linkedin.com/in/insujang" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="https://github.com/insujang" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="mailto:insujang@casys.kaist.ac.kr" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="/assets/cv/cv_insujang.pdf" target="_blank" rel="noopener me" title="Cv"><svg width="35.16" height="20.304" viewBox="0 0 35.16 20.304" class="feather" xmlns="http://www.w3.org/2000/svg"  fill="currentColor"><path d="M 26.568 16.656 L 26.592 16.656 A 20.535 20.535 0 0 1 26.807 15.883 Q 27.083 14.958 27.528 13.704 L 31.896 1.536 L 29.952 1.296 A 1.402 1.402 0 0 1 29.912 1.068 Q 29.885 0.78 29.952 0.41 A 3.068 3.068 0 0 1 29.952 0.408 Q 31.272 0.504 32.496 0.504 Q 33.222 0.504 34.175 0.47 A 82.192 82.192 0 0 0 35.088 0.432 A 1.36 1.36 0 0 1 35.16 0.858 Q 35.161 1.076 35.089 1.295 A 1.389 1.389 0 0 1 35.088 1.296 L 33.504 1.584 Q 33.12 2.16 32.544 3.72 L 26.352 20.304 L 25.512 20.304 L 18.408 1.536 L 16.464 1.296 A 1.402 1.402 0 0 1 16.424 1.068 Q 16.397 0.78 16.464 0.41 A 3.068 3.068 0 0 1 16.464 0.408 Q 17.351 0.473 18.584 0.494 A 75.288 75.288 0 0 0 19.872 0.504 Q 21.744 0.504 23.304 0.432 A 1.36 1.36 0 0 1 23.376 0.858 Q 23.377 1.076 23.305 1.295 A 1.389 1.389 0 0 1 23.304 1.296 L 21.312 1.584 L 25.704 13.704 Q 26.208 15.168 26.568 16.656 Z M 15.576 1.44 L 15.576 6.048 A 5.899 5.899 0 0 1 15.216 6.097 Q 14.997 6.12 14.808 6.12 A 2.978 2.978 0 0 1 14.557 6.11 Q 14.359 6.094 14.208 6.048 L 13.44 2.04 A 5.356 5.356 0 0 0 11.911 1.367 Q 11.226 1.179 10.414 1.114 A 11.147 11.147 0 0 0 9.528 1.08 Q 8.016 1.08 6.804 1.764 Q 5.592 2.448 4.74 3.612 A 8.175 8.175 0 0 0 3.756 5.406 A 10.035 10.035 0 0 0 3.432 6.348 A 11.682 11.682 0 0 0 2.992 9.037 A 13.406 13.406 0 0 0 2.976 9.696 A 14.18 14.18 0 0 0 3.141 11.9 A 11.725 11.725 0 0 0 3.42 13.2 A 10.167 10.167 0 0 0 3.997 14.787 A 8.064 8.064 0 0 0 4.68 15.984 A 6.163 6.163 0 0 0 6.083 17.446 A 5.727 5.727 0 0 0 6.66 17.82 A 5.12 5.12 0 0 0 8.996 18.474 A 6.121 6.121 0 0 0 9.264 18.48 Q 10.992 18.48 12.6 17.808 A 9.917 9.917 0 0 0 15.278 16.169 A 9.401 9.401 0 0 0 15.432 16.032 A 1.271 1.271 0 0 1 15.777 16.371 Q 15.886 16.525 15.972 16.724 A 2.727 2.727 0 0 1 16.056 16.944 A 14.323 14.323 0 0 1 13.856 18.656 Q 12.442 19.536 11.011 19.866 A 7.644 7.644 0 0 1 9.288 20.064 A 10.957 10.957 0 0 1 7.231 19.88 A 8.159 8.159 0 0 1 5.184 19.212 A 8.752 8.752 0 0 1 2.934 17.663 A 8.073 8.073 0 0 1 2.28 16.956 Q 1.128 15.552 0.564 13.764 Q 0 11.976 0 10.104 Q 0 8.208 0.648 6.396 Q 1.296 4.584 2.544 3.156 A 9.184 9.184 0 0 1 5.289 1.031 A 10.613 10.613 0 0 1 5.628 0.864 Q 7.464 0 9.816 0 Q 12.912 0 15.576 1.44 Z" vector-effect="non-scaling-stroke"/></svg></a></span><button id="menu-btn" class="hdr-btn d-inline d-md-none" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://insujang.github.io/posts/">Posts</a></li>
			<li><a href="https://insujang.github.io/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main container-lg animated fadeIn faster">
		<header class="post-header row">
			<div class="col-12 col-xl-3"></div>
			<div class="col-12 col-xl-9">
				<div class="post-meta"><span>Dec 11, 2020</span></div>
				<h1>Analyzing Ceph Network Module 3</h1>
			</div>
		</header>
		<article class="row">
			<div id="toc-aside" class="col-12 col-xl-3">
				<hr class="d-block d-xl-none">
				<div class="toc-title">What&#39;s on this Post</div>
				<nav id="TableOfContents">
  <ul>
    <li><a href="#monclient"><code>MonClient</code></a>
      <ul>
        <li><a href="#1-connecting-to-a-monitor">1. Connecting to a monitor</a></li>
        <li><a href="#2-sending-a-monitor-command">2. Sending a monitor command</a></li>
      </ul>
    </li>
  </ul>
</nav>
				<hr class="d-block d-xl-none">
			</div>

			<div class="content col-12 col-xl-9">
				<figure>
    <img src="/assets/images/201205/ceph-network-upper.png"
         alt="image"/> <figcaption>
            <p>High level Ceph architecture. <a href="https://docs.ceph.com/en/latest/architecture/">[src]</a></p>
        </figcaption>
</figure>

<p>In the previous posts <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, I illustrated how we establishes a connection between a server and a client using <code>AsyncMessenger</code> functions.</p>
<p>However, in high level Ceph architecture, there are some more abstracted APIs that are useful for specific purpose, e.g., accessing ceph-mon or ceph-osd, etc.
This post illustrates how <code>MonClient</code> is implemented.</p>
<h2 id="monclient"><code>MonClient</code><a href="#monclient" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>MonClient, considering its name, is a class that can be used to connect a Ceph monitor daemon.</p>
<p>Which client library a user uses to use Ceph, all libraries use <code>MonClient</code> to get a cluster map of the Ceph cluster from a Ceph monitor daemon.</p>
<ul>
<li><code>librados</code>: <code>librados::RadosClient</code> has a <code>MonClient</code> class instance to access the daemon.</li>
<li><code>librgw</code>: <code>RGWRados</code> uses <code>librados::IoCtx</code> and <code>librados::Rados</code>, which uses <code>librados::RadosClient</code> to connect to RADOS.</li>
<li><code>librbd</code>: <code>librbd::ImageCtx</code> uses <code>librados::IoCtx</code> to connect to RADOS.</li>
<li><code>libcephfs</code>: <code>Client</code> uses <code>MonClient</code> directly to connect to RADOS.</li>
</ul>
<figure>
    <img src="/assets/images/201211/ceph-network-monclient-flow.png"
         alt="image"/> <figcaption>
            <p><code>MonClient</code> internal execution flow. It internally uses <code>AsyncMessenger</code> for communication, which has been illustrated in the previous post. Note the bold function calls <code>Messenger::connect_to()</code> and <code>AsyncConnection::send_message()</code>.</p>
        </figcaption>
</figure>

<h3 id="1-connecting-to-a-monitor">1. Connecting to a monitor<a href="#1-connecting-to-a-monitor" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>A client needs to provide an information about a target monitor daemon.
There are several ways to provide the information:</p>
<ul>
<li>use <code>--mon-host-override &lt;ip&gt;</code> command-line argument or <code>mon_host_override</code> config option.</li>
<li>use a file located in the path specified by <code>monmap</code> config option.</li>
<li>use <code>fsid</code> config option (which I don&rsquo;t know much).</li>
<li>use <code>mon_host</code> config option.</li>
</ul>
<p><code>src/mon/MonClient.cc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">MonMap</span><span class="o">::</span><span class="n">build_initial</span><span class="p">(</span><span class="n">CephContext</span> <span class="o">*</span><span class="n">cct</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="n">ostream</span><span class="o">&amp;</span> <span class="n">errout</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">const</span> <span class="k">auto</span><span class="o">&amp;</span> <span class="n">conf</span> <span class="o">=</span> <span class="n">cct</span><span class="o">-&gt;</span><span class="n">_conf</span><span class="p">;</span>

  <span class="c1">// mon_host_override?
</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">mon_host_override</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">get_val</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;mon_host_override&#34;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mon_host_override</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">init_with_ips</span><span class="p">(</span><span class="n">mon_host_override</span><span class="p">,</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="s">&#34;noname-&#34;</span><span class="p">);</span>
    <span class="c1">// or
</span><span class="c1"></span>    <span class="n">init_with_hosts</span><span class="p">(</span><span class="n">mon_host_override</span><span class="p">,</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="s">&#34;noname-&#34;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// or, cct?
</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">addrs</span> <span class="o">=</span> <span class="n">cct</span><span class="o">-&gt;</span><span class="n">get_mon_addrs</span><span class="p">();</span>
  <span class="n">init_with_addrs</span><span class="p">(</span><span class="o">*</span><span class="n">addrs</span><span class="p">,</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="s">&#34;noname-&#34;</span><span class="p">);</span>

  <span class="c1">// or, file?
</span><span class="c1"></span>  <span class="k">const</span> <span class="k">auto</span> <span class="n">monmap</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">get_val</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;monmap&#34;</span><span class="p">);</span>
  <span class="n">init_with_monmap</span><span class="p">(</span><span class="n">monmap</span><span class="p">,</span> <span class="n">errout</span><span class="p">);</span>

  <span class="c1">// fsid from conf (omitted)
</span><span class="c1"></span>
  <span class="c1">// -m foo?
</span><span class="c1"></span>  <span class="k">const</span> <span class="k">auto</span> <span class="n">mon_host</span> <span class="o">=</span> <span class="n">conf</span><span class="p">.</span><span class="n">get_val</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#34;mon_host&#34;</span><span class="p">);</span>
  <span class="n">init_with_ips</span><span class="p">(</span><span class="n">mon_host</span><span class="p">,</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="s">&#34;noname-&#34;</span><span class="p">);</span>
  <span class="c1">// or
</span><span class="c1"></span>  <span class="n">init_with_hosts</span><span class="p">(</span><span class="n">mon_host</span><span class="p">,</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="s">&#34;noname-&#34;</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">MonMap</span><span class="o">::</span><span class="n">init_with_addrs</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">entity_addrvec_t</span><span class="o">&gt;&amp;</span> <span class="n">addrs</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">for_mkfs</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string_view</span> <span class="n">prefix</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">addr</span><span class="p">:</span> <span class="n">addrs</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// In src/mon/MonMap.h
</span><span class="c1"></span><span class="kt">void</span> <span class="nf">add</span> <span class="p">(</span><span class="k">const</span> <span class="n">mon_info_t</span><span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">mon_info</span><span class="p">[</span><span class="n">m</span><span class="p">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
  <span class="n">ranks</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
  <span class="n">calc_addr_mons</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">calc_addr_mons</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">addr_mons</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span> <span class="nl">p</span> <span class="p">:</span> <span class="n">mon_info</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">Auto</span><span class="o">&amp;</span> <span class="nl">a</span> <span class="p">:</span> <span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">.</span><span class="n">public_addrs</span><span class="p">.</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">addr_mons</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">.</span><span class="n">first</span><span class="p">;</span> <span class="c1">// type of addr_mons: std::map&lt;entity_addr_t, std::string&gt;
</span><span class="c1"></span>    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>In <code>RadosClient::connect()</code> it just creates an <code>AsyncMessenger</code> class instance by calling <code>Messenger::create_client_messenger()</code>.
Interestingly, an actual connection is not established in <code>RadosClient::connect()</code>. A connection seems to be established whenever a client sends a command.
So whenever you call <code>RadosClient::mon_command()</code> or <code>RadosClient::mon_command::async()</code>, it connects to the monitor that has <em>the closest rank</em> by calling <code>AsyncMessenger::connect_to_mon(monmap.get_addrs(...))</code>.</p>
<p><code>src/mon/MonClient.h</code>, <code>src/mon/MonClient.cc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">MonClient</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Dispatcher</span><span class="p">,</span> <span class="k">public</span> <span class="n">AuthClient</span><span class="p">,</span> <span class="k">public</span> <span class="n">AuthServer</span> <span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">CompletionToken</span><span class="o">&gt;</span>
  <span class="k">auto</span> <span class="n">start_mon_command</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;&amp;</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">const</span> <span class="n">cepb</span><span class="o">::</span><span class="n">buffer</span><span class="o">::</span><span class="n">list</span><span class="o">&amp;</span> <span class="n">inbl</span><span class="p">,</span> <span class="n">CompletionToken</span><span class="o">&amp;&amp;</span> <span class="n">token</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">boost</span><span class="o">::</span><span class="n">asio</span><span class="o">::</span><span class="n">async_completion</span><span class="o">&lt;</span><span class="n">CompletionToken</span><span class="p">,</span> <span class="n">CommandSig</span><span class="o">&gt;</span> <span class="n">init</span><span class="p">(</span><span class="n">token</span><span class="p">);</span>
    <span class="k">auto</span> <span class="n">h</span> <span class="o">=</span> <span class="n">CommandCompletion</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">service</span><span class="p">.</span><span class="n">get_executor</span><span class="p">(),</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">init</span><span class="p">.</span><span class="n">completion_handler</span><span class="p">));</span>
    <span class="k">auto</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MonCommand</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">,</span> <span class="o">++</span><span class="n">last_mon_command_tid</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">h</span><span class="p">));</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">inbl</span> <span class="o">=</span> <span class="n">inbl</span><span class="p">;</span>
    <span class="n">mon_commands</span><span class="p">.</span><span class="n">emplace</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
    <span class="n">_send_command</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">init</span><span class="p">.</span><span class="n">result</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
  <span class="p">...</span>
<span class="p">};</span>

<span class="c1">// In src/mon/MonClient.cc
</span><span class="c1"></span><span class="kt">void</span> <span class="n">MonClient</span><span class="o">::</span><span class="n">_send_command</span><span class="p">(</span><span class="n">MonCommand</span> <span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">r</span><span class="o">-&gt;</span><span class="n">target_con</span> <span class="o">=</span> <span class="n">messenger</span><span class="o">-&gt;</span><span class="n">connect_to_mon</span><span class="p">(</span><span class="n">monmap</span><span class="p">.</span><span class="n">get_addrs</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">target_rank</span><span class="p">),</span> <span class="nb">true</span> <span class="cm">/* anon */</span><span class="p">);</span>
  <span class="n">r</span><span class="o">-&gt;</span><span class="n">target_session</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">MonConnection</span><span class="p">(</span><span class="n">cct</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">target_con</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">auth_registry</span><span class="p">));</span>
  <span class="n">r</span><span class="o">-&gt;</span><span class="n">target_session</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">(</span><span class="n">monmap</span><span class="p">.</span><span class="n">get_epoch</span><span class="p">(),</span> <span class="n">entity_name</span><span class="p">);</span>

  <span class="n">MCommand</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MCommand</span><span class="p">(</span><span class="n">monmap</span><span class="p">.</span><span class="n">fsid</span><span class="p">);</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_tid</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">);</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">;</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_data</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">inbl</span><span class="p">);</span>
  <span class="n">r</span><span class="o">-&gt;</span><span class="n">target_session</span><span class="o">-&gt;</span><span class="n">queue_command</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p><code>MonConnection::queue_command()</code> actually does not use a queue; instead, it stores the message into the pending variable <code>pending_tell_command</code>:</p>
<p><code>src/mon/MonClient.h</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">MonConnection</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="kt">void</span> <span class="n">queue_command</span><span class="p">(</span><span class="n">Message</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">pending_tell_command</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div><p>The stored pending command will be executed <em><strong>after</strong></em> authentication is done.
This is a bit tricky that I could not fully understand it yet. Ceph seems to use <code>Protocol</code> class for authentication.</p>
<figure>
    <img src="/assets/images/201211/ceph-network-auth-protocol-flow.png"
         alt="image"/> <figcaption>
            <p>Authentication handling function execution flow. Protocol class is implemented with a lot of preprocessors that I could not follow the execution well.</p>
        </figcaption>
</figure>

<p>Here, the diagram above explains how the stored <code>pending_tell_command</code> is sent to the server. After authentication is done, several nested callback handlers are executed, and <code>MonConnection</code> calls <code>AsyncConnection::send_message2()</code> to send the stored command to the server at last.</p>
<h3 id="2-sending-a-monitor-command">2. Sending a monitor command<a href="#2-sending-a-monitor-command" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>I found out that <code>AsyncConnection::send_message2()</code> is used to send a command to the server. Let&rsquo;s dig into this function.</p>
<figure>
    <img src="/assets/images/201211/ceph-network-sendmsg-flow.png"
         alt="image"/> <figcaption>
            <p>Sending message flow.</p>
        </figcaption>
</figure>

<p><code>AsyncConnection::send_message2()</code> has been inherited from its parent class <code>Connection</code> (src/msg/Connection.h), which calls a pure virtual function <code>send_message()</code>. In this case, <code>AsyncConnection::send_message()</code> will be called.</p>
<p><code>src/msg/async/AsyncConnection.cc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">AsyncConnection</span><span class="o">::</span><span class="n">send_message</span><span class="p">(</span><span class="n">Message</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">get_priority</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_priority</span><span class="p">(</span><span class="n">async_msgr</span><span class="o">-&gt;</span><span class="n">get_Default_send_priority</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">().</span><span class="n">src</span> <span class="o">=</span> <span class="n">async_msgr</span><span class="o">-&gt;</span><span class="n">get_myname</span><span class="p">();</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">set_connection</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
  <span class="p">...</span>

  <span class="n">protocol</span><span class="o">-&gt;</span><span class="n">send_message</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>It again uses <code>Protocol</code> class instance to send a message.</p>
<p><code>src/msg/async/ProtocolV2.cc</code>, <code>src/msg/async/AsyncConnection.cc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="c1">// in src/msg/async/ProtocolV2.cc
</span><span class="c1"></span><span class="kt">void</span> <span class="n">ProtocolV2</span><span class="o">::</span><span class="n">send_message</span><span class="p">(</span><span class="n">Message</span> <span class="o">*</span><span class="n">m</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">queue_start</span> <span class="o">=</span> <span class="n">ceph</span><span class="o">::</span><span class="n">mono_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
  <span class="n">m</span><span class="o">-&gt;</span><span class="n">trace</span><span class="p">.</span><span class="n">event</span><span class="p">(</span><span class="s">&#34;async enqueueing message&#34;</span><span class="p">);</span>
  <span class="n">out_queue</span><span class="p">[</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">get_priority</span><span class="p">()].</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">out_queue_entry_t</span><span class="p">{</span><span class="n">is_prepared</span><span class="p">,</span> <span class="n">m</span><span class="p">});</span>
  <span class="k">if</span> <span class="p">(((</span><span class="o">!</span><span class="n">replacing</span> <span class="o">&amp;&amp;</span> <span class="n">can_wirte</span><span class="p">)</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">STANDBY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">write_in_progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">connection</span><span class="o">-&gt;</span><span class="n">center</span><span class="o">-&gt;</span><span class="n">dispatch_event_external</span><span class="p">(</span><span class="n">connection</span><span class="o">-&gt;</span><span class="n">write_handler</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// in src/msg/async/AsyncConnection.cc
</span><span class="c1"></span><span class="n">AsyncConnection</span><span class="o">::</span><span class="n">AsyncConnection</span><span class="p">(...)</span> <span class="o">:</span> <span class="p">...</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">write_handler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">C_handler_write</span><span class="p">(</span><span class="k">this</span><span class="p">);</span> <span class="c1">// This callback is used by ProtocolV2::send_message().
</span><span class="c1"></span>  <span class="p">...</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">C_handle_write</span> <span class="o">:</span> <span class="k">public</span> <span class="n">EventCallback</span> <span class="p">{</span>
  <span class="n">AsyncConnectionRef</span> <span class="n">conn</span><span class="p">;</span>

 <span class="k">public</span><span class="o">:</span>
  <span class="k">explicit</span> <span class="n">C_handle_write</span><span class="p">(</span><span class="n">AsyncConnectionRef</span> <span class="n">c</span><span class="p">)</span><span class="o">:</span> <span class="n">conn</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="p">{}</span>
  <span class="kt">void</span> <span class="nf">do_request</span><span class="p">(</span><span class="kt">uint64_t</span> <span class="n">fd</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="n">conn</span><span class="o">-&gt;</span><span class="n">handle_write</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">AsyncConnection</span><span class="o">::</span><span class="n">handle_write</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">protocol</span><span class="o">-&gt;</span><span class="n">write_event</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// in src/msg/async/ProtocolV2.cc
</span><span class="c1"></span><span class="kt">void</span> <span class="n">ProtocolV2</span><span class="o">::</span><span class="n">write_event</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="k">do</span> <span class="p">{</span>
    <span class="c1">// deduced type: ProtocolV2::out_queue_entry_t
</span><span class="c1"></span>    <span class="k">const</span> <span class="k">auto</span> <span class="n">out_entry</span> <span class="o">=</span> <span class="n">_get_next_outgoing</span><span class="p">();</span>
    <span class="p">...</span>

    <span class="c1">// send message or requeue messages amy not encode message
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">out_entry</span><span class="p">.</span><span class="n">is_prepared</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">prepare_send_message</span><span class="p">(</span><span class="n">connection</span><span class="o">-&gt;</span><span class="n">get_features</span><span class="p">(),</span> <span class="n">out_entry</span><span class="p">.</span><span class="n">m</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">write_message</span><span class="p">(</span><span class="n">out_entry</span><span class="p">.</span><span class="n">m</span><span class="p">,</span> <span class="n">more</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">can_write</span><span class="p">);</span>
  <span class="n">write_in_progress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="n">ssize_t</span> <span class="n">ProtocolV2</span><span class="o">::</span><span class="n">write_message</span><span class="p">(</span><span class="n">Message</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">more</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">ceph_msg_header</span> <span class="o">&amp;</span><span class="n">header</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_header</span><span class="p">();</span>
  <span class="n">ceph_msg_footer</span> <span class="o">&amp;</span><span class="n">footer</span> <span class="o">=</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_footer</span><span class="p">();</span>
  <span class="n">ceph_msg_header2</span> <span class="n">header2</span> <span class="p">{</span><span class="n">header</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span>      <span class="n">header</span><span class="p">.</span><span class="n">tid</span><span class="p">,</span>
                            <span class="n">header</span><span class="p">.</span><span class="n">type</span><span class="p">,</span>     <span class="n">header</span><span class="p">.</span><span class="n">priority</span><span class="p">,</span>
                            <span class="n">header</span><span class="p">.</span><span class="n">version</span><span class="p">,</span>
                            <span class="n">init_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>    <span class="n">header</span><span class="p">.</span><span class="n">data_off</span><span class="p">,</span>
                            <span class="n">init_le64</span><span class="p">(</span><span class="n">ack_sqe</span><span class="p">),</span>
                            <span class="n">footer</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>    <span class="n">header</span><span class="p">.</span><span class="n">compat_version</span><span class="p">,</span>
                            <span class="n">header</span><span class="p">.</span><span class="n">reserved</span><span class="p">};</span>

  <span class="c1">// deduced type: MessageFrame
</span><span class="c1"></span>  <span class="k">auto</span> <span class="n">message</span> <span class="o">=</span> <span class="n">MessageFrame</span><span class="o">::</span><span class="n">Encode</span><span class="p">(</span><span class="n">header2</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_payload</span><span class="p">(),</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_middle</span><span class="p">(),</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">get_data</span><span class="p">());</span>
  <span class="n">append_frame</span><span class="p">(</span><span class="n">message</span><span class="p">);</span> <span class="c1">// The message is appended to connection-&gt;outgoing_bl here.
</span><span class="c1"></span>  <span class="n">ssize_t</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">connection</span><span class="o">-&gt;</span><span class="n">_try_send</span><span class="p">(</span><span class="n">more</span><span class="p">);</span>
  <span class="p">...</span>
  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span> <span class="nc">F</span><span class="o">&gt;</span>
<span class="kt">bool</span> <span class="n">ProtocolV2</span><span class="o">::</span><span class="n">append_frame</span><span class="p">(</span><span class="n">F</span><span class="o">&amp;</span> <span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">ceph</span><span class="o">::</span><span class="n">bufferlist</span> <span class="n">bl</span><span class="p">;</span>
  <span class="n">bl</span> <span class="o">=</span> <span class="n">frame</span><span class="p">.</span><span class="n">get_buffer</span><span class="p">(</span><span class="n">tx_frame_asm</span><span class="p">);</span>
  <span class="n">connection</span><span class="o">-&gt;</span><span class="n">outgoing_bl</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">bl</span><span class="p">);</span>
  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// in src/msg/async/AsyncConnection.cc
</span><span class="c1"></span><span class="n">ssize_t</span> <span class="n">AsyncConnection</span><span class="o">::</span><span class="n">_try_send</span><span class="p">(</span><span class="kt">bool</span> <span class="n">more</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="n">ssize_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">cs</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">outgoing_bl</span><span class="p">,</span> <span class="n">more</span><span class="p">);</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div><p>Again, <code>ProtocolV2::send_message()</code> uses <code>EventCenter::dispatch_event_external()</code> function to pass the job to a seperate worker thread. Through the write handler of <code>AsyncConnection</code>, <code>ProtocolV2::write_message()</code> is responsible to build a message and send it.</p>
<p><code>ProtocolV2::write_message()</code> builds an encoded message using <code>MessageFrame::Encode()</code> static function, appends it into an <code>outgoing_bl</code> (buffer variable) of <code>AsyncConnection</code> class variable by calling <code>ProtocolV2::append_frame()</code>, and sends it by calling <code>AsyncConection::_try_send()</code>.</p>
<p>In the function <code>AsyncConnection::_try_send()</code>, the class instance uses <code>ConnectedSocket</code> (variable name: cs) to send a message to the remote peer. Here, if we specified a network stack as POSIX, <code>PosixConnectedSocketImpl</code> (defined in src/msg/async/PosixStack.cc) is used for its internal implementation:</p>
<p><code>src/msg/async/Stack.h</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">ConnectedSocket</span> <span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">ConnectedSocketImpl</span><span class="o">&gt;</span> <span class="n">_csi</span><span class="p">;</span>

 <span class="k">public</span><span class="o">:</span>
  <span class="n">ssize_t</span> <span class="n">send</span><span class="p">(</span><span class="n">ceph</span><span class="o">::</span><span class="n">buffer</span><span class="o">::</span><span class="n">list</span> <span class="o">&amp;</span><span class="n">bl</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">more</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">_csi</span><span class="o">-&gt;</span><span class="n">send</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">more</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">};</span>
</code></pre></div><p><code>src/msg/async/PosixStack.cc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="kt">int</span> <span class="n">PosixWorker</span><span class="o">::</span><span class="n">connect</span><span class="p">(</span><span class="k">const</span> <span class="n">entity_addr_t</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="n">SocketOptions</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span> <span class="n">ConnectedSocket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">ConnectedSocket</span><span class="p">(</span>
      <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">PosixConnectedSocketImpl</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">PosixConnectedSocketImpl</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="o">!</span><span class="n">opts</span><span class="p">.</span><span class="n">nonblock</span><span class="p">)));</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>So, calling <code>cs.send()</code> eventually calls <code>PosixConnectedSocketImpl::send()</code>, which calls <code>::sendmsg()</code> system call until all bytes are transferred.</p>
<p><code>src/msg/async/PosixStack.cc</code></p>
<div class="highlight"><pre class="chroma"><code class="language-cpp" data-lang="cpp"><span class="k">class</span> <span class="nc">PosixConnectedSocketImpl</span> <span class="k">final</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ConnectedSocketImpl</span> <span class="p">{</span>
  <span class="p">...</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="p">...</span>
  <span class="n">ssize_t</span> <span class="n">send</span><span class="p">(</span><span class="n">ceph</span><span class="o">::</span><span class="n">buffer</span><span class="o">::</span><span class="n">list</span> <span class="o">&amp;</span><span class="n">bl</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">more</span><span class="p">)</span> <span class="k">override</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">ssize_t</span> <span class="n">r</span> <span class="o">=</span> <span class="n">do_sendmsg</span><span class="p">(</span><span class="n">_fd</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msglen</span><span class="p">,</span> <span class="n">left_pbrs</span> <span class="o">||</span> <span class="n">more</span><span class="p">);</span>
    <span class="p">...</span>
  <span class="p">}</span>

  <span class="cp">#ifndef _WIN32
</span><span class="cp"></span>  <span class="k">static</span> <span class="n">ssize_t</span> <span class="nf">do_sendmsg</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="nc">msghdr</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">more</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">size_t</span> <span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">MSGR_SIGPIPE_STOPPER</span><span class="p">;</span>
      <span class="n">ssize_t</span> <span class="n">r</span> <span class="o">=</span> <span class="o">::</span><span class="n">sendmsg</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="n">MSG_NOSIGNAL</span> <span class="o">|</span> <span class="p">(</span><span class="n">more</span> <span class="o">?</span> <span class="nl">MSG_MORE</span> <span class="p">:</span> <span class="mi">0</span><span class="p">));</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">ceph_sock_errno</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">err</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">sent</span> <span class="o">+=</span> <span class="n">r</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">sent</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">ssize_t</span><span class="p">)</span><span class="n">sent</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="cp">#endif
</span></code></pre></div><p>Note that all transmission is done by a seperate worker thread, hence an asynchronous manner from the viewpoint of the main thread.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="http://insujang.github.io/2020-12-05/analyzing-ceph-network-module-1/">Analyzing Ceph Network Module 1</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="http://insujang.github.io/2020-12-10/analyzing-ceph-network-module-2/">Analyzing Ceph Network Module 2</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

			</div>
		</article>

		<hr class="post-end">
		<footer class="post-info">
			<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>Insu Jang</p>
			<p>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://insujang.github.io/tags/study">study</a></span><span class="tag"><a href="https://insujang.github.io/tags/ceph">ceph</a></span>
			</p>
		</footer>
		
		<div id="comments" class="thin">

<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'insujang';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2017 - 2020 <a href="https://insujang.github.io">Insu Jang</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a>
		</p>
	</footer>



	<script src="https://insujang.github.io/js/bundle.min.2803cd839686977006471d106bcb3bfc2eaed4c348aa5adf01e47a8cecc6293b.js" integrity="sha256-KAPNg5aGl3AGRx0Qa8s7/C6u1MNIqlrfAeR6jOzGKTs=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-158110335-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
