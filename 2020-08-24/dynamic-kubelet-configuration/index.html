<!DOCTYPE html>
<html lang="en-us">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Dynamic Kubelet Configuration">
<meta itemprop="description" content="Kubelet, at launch time, loads configuration files from pre-specified files. Changed configurations are not applied into the running Kubelet process during runtime, hence manual restarting Kubelet is required after modification.
Dynamic Kubelet configuration eliminates this burden, making Kubelet monitors its configuration changes and restarts when it is updated1. It uses Kubernetes a ConfigMap object.
Kubelet Flags for Dynamic Configuration Dynamic kubelet configuration is not enabled by default. To be specific, one of required configurations is missing; the following flags for Kubelet are required for dynamic configuration:">
<meta itemprop="datePublished" content="2020-08-24T09:21:00+09:00" />
<meta itemprop="dateModified" content="2020-08-24T09:21:00+09:00" />
<meta itemprop="wordCount" content="1081">



<meta itemprop="keywords" content="study,kubernetes," />
<meta property="og:title" content="Dynamic Kubelet Configuration" />
<meta property="og:description" content="Kubelet, at launch time, loads configuration files from pre-specified files. Changed configurations are not applied into the running Kubelet process during runtime, hence manual restarting Kubelet is required after modification.
Dynamic Kubelet configuration eliminates this burden, making Kubelet monitors its configuration changes and restarts when it is updated1. It uses Kubernetes a ConfigMap object.
Kubelet Flags for Dynamic Configuration Dynamic kubelet configuration is not enabled by default. To be specific, one of required configurations is missing; the following flags for Kubelet are required for dynamic configuration:" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://insujang.github.io/2020-08-24/dynamic-kubelet-configuration/" />
<meta property="article:published_time" content="2020-08-24T09:21:00+09:00" />
<meta property="article:modified_time" content="2020-08-24T09:21:00+09:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Dynamic Kubelet Configuration"/>
<meta name="twitter:description" content="Kubelet, at launch time, loads configuration files from pre-specified files. Changed configurations are not applied into the running Kubelet process during runtime, hence manual restarting Kubelet is required after modification.
Dynamic Kubelet configuration eliminates this burden, making Kubelet monitors its configuration changes and restarts when it is updated1. It uses Kubernetes a ConfigMap object.
Kubelet Flags for Dynamic Configuration Dynamic kubelet configuration is not enabled by default. To be specific, one of required configurations is missing; the following flags for Kubelet are required for dynamic configuration:"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Dynamic Kubelet Configuration</title>
	<link rel="stylesheet" href="https://insujang.github.io/css/style.min.19071adf92133554d1389eff80b6cfc2c08856a2608060f97b215d6d1aa3dd47.css" integrity="sha256-GQca35ITNVTROJ7/gLbPwsCIVqJggGD5eyFdbRqj3Uc=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper container-lg">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://insujang.github.io">Better Tomorrow with Computer Science</a>
				</div>
				<nav class="site-nav d-md-inline d-none">
					
				<a href="https://insujang.github.io/posts/">Posts</a>
				<a href="https://insujang.github.io/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social d-md-inline d-none"><a href="https://linkedin.com/in/insujang" target="_blank" rel="noopener me" title="Linkedin"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg></a><a href="https://github.com/insujang" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a><a href="mailto:insujang@casys.kaist.ac.kr" target="_blank" rel="noopener me" title="Email"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg></a><a href="/assets/cv/cv_insujang.pdf" target="_blank" rel="noopener me" title="Cv"><svg width="35.16" height="20.304" viewBox="0 0 35.16 20.304" class="feather" xmlns="http://www.w3.org/2000/svg"  fill="currentColor"><path d="M 26.568 16.656 L 26.592 16.656 A 20.535 20.535 0 0 1 26.807 15.883 Q 27.083 14.958 27.528 13.704 L 31.896 1.536 L 29.952 1.296 A 1.402 1.402 0 0 1 29.912 1.068 Q 29.885 0.78 29.952 0.41 A 3.068 3.068 0 0 1 29.952 0.408 Q 31.272 0.504 32.496 0.504 Q 33.222 0.504 34.175 0.47 A 82.192 82.192 0 0 0 35.088 0.432 A 1.36 1.36 0 0 1 35.16 0.858 Q 35.161 1.076 35.089 1.295 A 1.389 1.389 0 0 1 35.088 1.296 L 33.504 1.584 Q 33.12 2.16 32.544 3.72 L 26.352 20.304 L 25.512 20.304 L 18.408 1.536 L 16.464 1.296 A 1.402 1.402 0 0 1 16.424 1.068 Q 16.397 0.78 16.464 0.41 A 3.068 3.068 0 0 1 16.464 0.408 Q 17.351 0.473 18.584 0.494 A 75.288 75.288 0 0 0 19.872 0.504 Q 21.744 0.504 23.304 0.432 A 1.36 1.36 0 0 1 23.376 0.858 Q 23.377 1.076 23.305 1.295 A 1.389 1.389 0 0 1 23.304 1.296 L 21.312 1.584 L 25.704 13.704 Q 26.208 15.168 26.568 16.656 Z M 15.576 1.44 L 15.576 6.048 A 5.899 5.899 0 0 1 15.216 6.097 Q 14.997 6.12 14.808 6.12 A 2.978 2.978 0 0 1 14.557 6.11 Q 14.359 6.094 14.208 6.048 L 13.44 2.04 A 5.356 5.356 0 0 0 11.911 1.367 Q 11.226 1.179 10.414 1.114 A 11.147 11.147 0 0 0 9.528 1.08 Q 8.016 1.08 6.804 1.764 Q 5.592 2.448 4.74 3.612 A 8.175 8.175 0 0 0 3.756 5.406 A 10.035 10.035 0 0 0 3.432 6.348 A 11.682 11.682 0 0 0 2.992 9.037 A 13.406 13.406 0 0 0 2.976 9.696 A 14.18 14.18 0 0 0 3.141 11.9 A 11.725 11.725 0 0 0 3.42 13.2 A 10.167 10.167 0 0 0 3.997 14.787 A 8.064 8.064 0 0 0 4.68 15.984 A 6.163 6.163 0 0 0 6.083 17.446 A 5.727 5.727 0 0 0 6.66 17.82 A 5.12 5.12 0 0 0 8.996 18.474 A 6.121 6.121 0 0 0 9.264 18.48 Q 10.992 18.48 12.6 17.808 A 9.917 9.917 0 0 0 15.278 16.169 A 9.401 9.401 0 0 0 15.432 16.032 A 1.271 1.271 0 0 1 15.777 16.371 Q 15.886 16.525 15.972 16.724 A 2.727 2.727 0 0 1 16.056 16.944 A 14.323 14.323 0 0 1 13.856 18.656 Q 12.442 19.536 11.011 19.866 A 7.644 7.644 0 0 1 9.288 20.064 A 10.957 10.957 0 0 1 7.231 19.88 A 8.159 8.159 0 0 1 5.184 19.212 A 8.752 8.752 0 0 1 2.934 17.663 A 8.073 8.073 0 0 1 2.28 16.956 Q 1.128 15.552 0.564 13.764 Q 0 11.976 0 10.104 Q 0 8.208 0.648 6.396 Q 1.296 4.584 2.544 3.156 A 9.184 9.184 0 0 1 5.289 1.031 A 10.613 10.613 0 0 1 5.628 0.864 Q 7.464 0 9.816 0 Q 12.912 0 15.576 1.44 Z" vector-effect="non-scaling-stroke"/></svg></a></span><button id="menu-btn" class="hdr-btn d-inline d-md-none" title="Menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://insujang.github.io/posts/">Posts</a></li>
			<li><a href="https://insujang.github.io/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main container-lg animated fadeIn faster">
		<header class="post-header row">
			<div class="col-12 col-xl-3"></div>
			<div class="col-12 col-xl-9">
				<div class="post-meta"><span>Aug 24, 2020</span></div>
				<h1>Dynamic Kubelet Configuration</h1>
			</div>
		</header>
		<article class="row">
			<div id="toc-aside" class="col-12 col-xl-3">
				<hr class="d-block d-xl-none">
				<div class="toc-title">What&#39;s on this Post</div>
				<nav id="TableOfContents">
  <ul>
    <li><a href="#kubelet-flags-for-dynamic-configuration">Kubelet Flags for Dynamic Configuration</a>
      <ul>
        <li><a href="#why---dynamic-config-dir-flag-is-required">Why <code>--dynamic-config-dir</code> flag is required?</a></li>
      </ul>
    </li>
    <li><a href="#dynamic-configuration-setup">Dynamic Configuration Setup</a>
      <ul>
        <li><a href="#creating-a-configmap">Creating a ConfigMap</a></li>
        <li><a href="#adding-more-configurations-into-the-configmap">Adding more Configurations into the ConfigMap</a></li>
        <li><a href="#specifying-node-to-use-the-configmap">Specifying Node to use the ConfigMap</a></li>
        <li><a href="#verifying-dynamic-kubelet-configuration">Verifying Dynamic Kubelet Configuration</a></li>
      </ul>
    </li>
    <li><a href="#authentication-and-authorization">Authentication and Authorization</a></li>
  </ul>
</nav>
				<hr class="d-block d-xl-none">
			</div>

			<div class="content col-12 col-xl-9">
				<p>Kubelet, at launch time, loads configuration files from pre-specified files.
Changed configurations are not applied into the running Kubelet process during runtime, hence manual restarting Kubelet is required after modification.</p>
<p><em>Dynamic Kubelet configuration</em> eliminates this burden, making Kubelet monitors its configuration changes and restarts when it is updated<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>.
It uses Kubernetes a <strong>ConfigMap</strong> object.</p>
<h2 id="kubelet-flags-for-dynamic-configuration">Kubelet Flags for Dynamic Configuration<a href="#kubelet-flags-for-dynamic-configuration" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Dynamic kubelet configuration is not enabled by default.
To be specific, one of required configurations is missing;
the following flags for Kubelet are required for dynamic configuration:</p>
<ol>
<li><code>--feature-gates=&quot;DynamicKubeletConfig=true&quot;</code>: enabled by default since Kubernetes 1.11 <sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup>, so nothing should be done manually.</li>
<li><code>--dynamic-config-dir=&lt;path&gt;</code>: this flag for Kubelet is required to enable dynamic kubelet configuration.</li>
</ol>
<h3 id="why---dynamic-config-dir-flag-is-required">Why <code>--dynamic-config-dir</code> flag is required?<a href="#why---dynamic-config-dir-flag-is-required" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<figure>
    <img src="/assets/images/200824/kubelet-reconfigure-diagram.png"
         alt="image"/> <figcaption>
            <p>Kubelet reconfigure diagram. Source: <a href="https://kubernetes.io/blog/2018/07/11/dynamic-kubelet-configuration/">Kubernetes: Dynamic Kubelet Configuration</a></p>
        </figcaption>
</figure>

<p>The figure above illustrates how Kubelet uses dynamic Kubelet reconfiguration.
At step 4~5, Kubelet <strong>&ldquo;checkpoints&rdquo;</strong> the modified configmap from the apiserver to its local storage, and loads the data after restarted.
Here, the checkpointed configmap should be stored at somewhere, and <code>--dynamic-config-dir</code> is the one.
When you specify <code>--dynamic-config-dir</code>, Kubelet automatically initializes itself with config checkpoint:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">Aug <span class="m">21</span> 18:54:30 localhost.worker kubelet<span class="o">[</span>107800<span class="o">]</span>: I0821 18:54:30.679461  <span class="m">107800</span> watch.go:128<span class="o">]</span> kubelet config controller: assigned ConfigMap was updated
Aug <span class="m">21</span> 18:54:34 localhost.worker kubelet<span class="o">[</span>107800<span class="o">]</span>: I0821 18:54:34.776572  <span class="m">107800</span> download.go:181<span class="o">]</span> kubelet config controller: checking in-memory store <span class="k">for</span> /api/v1/namespaces/kube-system/configmaps/k8s-worker16
Aug <span class="m">21</span> 18:54:34 localhost.worker kubelet<span class="o">[</span>107800<span class="o">]</span>: I0821 18:54:34.776605  <span class="m">107800</span> download.go:187<span class="o">]</span> kubelet config controller: found /api/v1/namespaces/kube-system/configmaps/k8s-worker16 in in-memory store, UID: 5808539f-48e3-4e47-8ce6-c261c48fa1d9, ResourceVersion: <span class="m">437429</span>
Aug <span class="m">21</span> 18:54:34 localhost.worker kubelet<span class="o">[</span>107800<span class="o">]</span>: I0821 18:54:34.806121  <span class="m">107800</span> configsync.go:205<span class="o">]</span> kubelet config controller: Kubelet restarting to use /api/v1/namespaces/kube-system/configmaps/k8s-worker16, UID: 5808539f-48e3-4e47-8ce6-c261c48fa1d9, ResourceVersion: 437429, KubeletConfigKey: kubelet
Aug <span class="m">21</span> 18:54:34 localhost.worker systemd<span class="o">[</span>1<span class="o">]</span>: kubelet.service: Succeeded.
Aug <span class="m">21</span> 18:54:45 localhost.worker systemd<span class="o">[</span>1<span class="o">]</span>: kubelet.service: Scheduled restart job, restart counter is at 19.
Aug <span class="m">21</span> 18:54:45 localhost.worker systemd<span class="o">[</span>1<span class="o">]</span>: Stopped kubelet: The Kubernetes Node Agent.
Aug <span class="m">21</span> 18:54:45 localhost.worker systemd<span class="o">[</span>1<span class="o">]</span>: Started kubelet: The Kubernetes Node Agent.
Aug <span class="m">21</span> 18:54:45 localhost.worker kubelet<span class="o">[</span>108430<span class="o">]</span>: I0821 18:54:45.115977  <span class="m">108430</span> controller.go:101<span class="o">]</span> kubelet config controller: starting controller
Aug <span class="m">21</span> 18:54:45 localhost.worker kubelet<span class="o">[</span>108430<span class="o">]</span>: I0821 18:54:45.116038  <span class="m">108430</span> controller.go:267<span class="o">]</span> kubelet config controller: ensuring filesystem is <span class="nb">set</span> up correctly
Aug <span class="m">21</span> 18:54:45 localhost.worker kubelet<span class="o">[</span>108430<span class="o">]</span>: I0821 18:54:45.116045  <span class="m">108430</span> fsstore.go:59<span class="o">]</span> kubelet config controller: initializing config checkpoints directory <span class="s2">&#34;/var/lib/kubelet/dynamic-config/store&#34;</span>
...
</code></pre></div><h2 id="dynamic-configuration-setup">Dynamic Configuration Setup<a href="#dynamic-configuration-setup" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>Dynamic Kubelet Configuration uses ConfigMap objects.
Therefore, a ConfigMap object for Kubelet configurations and related authorized access permission is required.</p>
<h3 id="creating-a-configmap">Creating a ConfigMap<a href="#creating-a-configmap" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Dynamic Kubelet onfiguration cannot be used with the existing configurations given by flags and <code>--config</code> file.
In other words, even if a configuration is set by the flags or <code>--config</code> file, this configurations are not enabled and only Dynamic configurations are applied.
<strong>For this reason, <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> recommends to start from the current configuration.</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl proxy --port<span class="o">=</span><span class="m">8001</span> <span class="p">&amp;</span>
$ <span class="nv">NODE_NAME</span><span class="o">=</span><span class="s2">&#34;the-name-of-the-node-you-are-reconfiguring&#34;</span><span class="p">;</span> curl -sSL <span class="s2">&#34;http://localhost:8001/api/v1/nodes/</span><span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span><span class="s2">/proxy/configz&#34;</span> <span class="p">|</span> jq <span class="s1">&#39;.kubeletconfig|.kind=&#34;KubeletConfiguration&#34;|.apiVersion=&#34;kubelet.config.k8s.io/v1beta1&#34;&#39;</span> &gt; kubelet_configz_<span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span>
$ kubectl <span class="o">(</span>-n kube-system<span class="o">)</span> create configmap node-config --from-file<span class="o">=</span><span class="nv">kubelet</span><span class="o">=</span>kubelet_configz_<span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span>
</code></pre></div><blockquote>
<p>It only works at control plane nodes, and currently I could not figure out which permission is required for this operation.</p>
<p>I found that the configmap does not need to be the namespace <code>kube-system</code>. Also works if it is stored in the default namespace.</p>
</blockquote>
<h3 id="adding-more-configurations-into-the-configmap">Adding more Configurations into the ConfigMap<a href="#adding-more-configurations-into-the-configmap" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>You should see your ConfigMap object with the following command:</p>
<pre><code>$ kubectl get configmaps (-n NAMESPACE)
</code></pre><p>Now you can edit the ConfigMap object with <code>edit</code> subcommand:</p>
<pre><code>$ kubectl edit configmaps node-config (-n NAMESPACE)
</code></pre><p>The format of the ConfigMap object looks like this:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span><span class="k">kind</span><span class="p">:</span><span class="w"> </span>ConfigMap<span class="w">
</span><span class="w"></span><span class="k">metadta</span><span class="p">:</span><span class="w"> </span>&lt;not<span class="w"> </span>important&gt;<span class="w">
</span><span class="w"></span><span class="k">name</span><span class="p">:</span><span class="w"> </span>node-config<span class="w">
</span><span class="w"></span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w"></span><span class="k">data</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">kubelet</span><span class="p">:</span><span class="w"> </span><span class="sd">|     # &lt;- Do not omit &#39;|&#39;.</span><span class="w">
</span><span class="w">        </span>{<span class="w">
</span><span class="w">            </span><span class="k">&#34;kind&#34;: </span><span class="s2">&#34;KubeletConfiguration&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="k">&#34;apiVersion&#34;: </span><span class="s2">&#34;kubelet.config.k8s.io/v1beta1&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span>&lt;other<span class="w"> </span>Kubelet<span class="w"> </span>configurations<span class="w"> </span>in<span class="w"> </span>JSON<span class="w"> </span>format<span class="sd">&gt;
</span><span class="sd">        }</span><span class="w">
</span></code></pre></div><p>The ConfigMap object itself follows YAML format, but its content in <code>data.kubelet</code> foolows JSON format. Do not be confused.
Available Kubelet configuration key/value can be investigated in [<a href="https://github.com/kubernetes/kubelet/blob/master/config/v1beta1/types.go#L75">here</a>]</p>
<p>In my case, I want to try to restrict allocatable resources via dynamic Kubernetes configuration. I added several Kubelet flags in the ConfigMap object:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">&lt;omitted&gt;<span class="w">
</span><span class="w"></span><span class="k">data</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">kubelet</span><span class="p">:</span><span class="w"> </span><span class="sd">|
</span><span class="sd">        {</span><span class="w">
</span><span class="w">            </span><span class="k">&#34;kind&#34;: </span><span class="s2">&#34;KubeletConfiguration&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="k">&#34;apiVersion&#34;: </span><span class="s2">&#34;kubelet.config.k8s.io/v1beta1&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">            </span>&lt;other<span class="w"> </span>default<span class="w"> </span>configurations<span class="w"> </span>are<span class="w"> </span>omitted&gt;<span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="k">&#34;systemReserved&#34;: </span>{<span class="w">
</span><span class="w">                </span><span class="k">&#34;cpu&#34;: </span><span class="s2">&#34;2&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">                </span><span class="k">&#34;memory&#34;: </span><span class="s2">&#34;2Gi&#34;</span><span class="w">
</span><span class="w">            </span>}<span class="p">,</span><span class="w">
</span><span class="w">            </span><span class="k">&#34;kubeReserved&#34;: </span>{<span class="w">
</span><span class="w">                </span><span class="k">&#34;cpu&#34;: </span><span class="s2">&#34;1&#34;</span><span class="p">,</span><span class="w">
</span><span class="w">                </span><span class="k">&#34;memory&#34;: </span><span class="s2">&#34;1Gi&#34;</span><span class="w">
</span><span class="w">            </span>}<span class="p">,</span><span class="w">
</span><span class="w">            </span>systemReservedCgroup<span class="s2">&#34;: &#34;</span>/system-reserved<span class="s2">&#34;,
</span><span class="s2">            kubeReservedCgroup&#34;</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;/kube-reserved&#34;</span><span class="w">
</span><span class="w">        </span>}<span class="w">
</span></code></pre></div><h3 id="specifying-node-to-use-the-configmap">Specifying Node to use the ConfigMap<a href="#specifying-node-to-use-the-configmap" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>One more thing to do is to add <code>spec</code> to Kubernetes Node object to indicate which ConfigMap object should be used for dynamic Kubelet configuration for which node.</p>
<p>Oen an editor with the following command to specify it:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ kubectl edit node <span class="si">${</span><span class="nv">NODE_NAME</span><span class="si">}</span>
</code></pre></div><p>You have nothing in <code>spec</code> section if it is the first time to edit it.
Add <code>configSource</code> element as follows (note that it is YAML format):</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">configSource</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">kubeletConfigKey</span><span class="p">:</span><span class="w"> </span>kubelet<span class="w">
</span><span class="w">        </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>node-config<span class="w">
</span><span class="w">        </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span></code></pre></div><p>each of which key means:</p>
<ul>
<li><code>kubeletConfigKey</code>: the key in <code>data</code> dictionary in the ConfigMap object. In our case, we specified it as <code>kubelet</code> (<code>kubelet: | { ... }</code>).</li>
<li><code>name</code>: name of the ConfigMap object.</li>
<li><code>namespace</code>: namespace that the ConfigMap object is in.</li>
</ul>
<p>Once you specify the spec, the Kubelet in the target node will automatically restart to apply dynamic configuration.</p>
<h3 id="verifying-dynamic-kubelet-configuration">Verifying Dynamic Kubelet Configuration<a href="#verifying-dynamic-kubelet-configuration" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h3>
<p>Check the result with <code>$ kubectl get nodes ${NODE_NAME} -o yaml</code>.</p>
<ul>
<li>First, check whether the spec is successfully applied:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">managedFields</span><span class="p">:</span><span class="w">
</span><span class="w">    </span>- <span class="k">apiVersion</span><span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w">    </span>- <span class="k">fieldsType</span><span class="p">:</span><span class="w"> </span>FieldsV1<span class="w">
</span><span class="w">    </span><span class="k">fieldsV1</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">f:spec</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">f:configSource</span><span class="p">:</span><span class="w">
</span><span class="w">            </span>...<span class="w">
</span><span class="w"></span><span class="k">spec</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">configSource</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">kubeletConfigKey</span><span class="p">:</span><span class="w"> </span>kubelet<span class="w">
</span><span class="w">        </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>node-config<span class="w">
</span><span class="w">        </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span></code></pre></div><ul>
<li>Second, the Kubelet updates its <strong>status</strong> whether the configuration is successfully applied or not:</li>
</ul>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="k">status</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">addresses</span><span class="p">:</span><span class="w"> </span>&lt;omitted<span class="sd">&gt;
</span><span class="sd">    allocatable: &lt;omitted&gt;</span><span class="w">
</span><span class="w">    </span><span class="k">capacity</span><span class="p">:</span><span class="w"> </span>&lt;omitted<span class="sd">&gt;
</span><span class="sd">    conditions: &lt;omitted&gt;</span><span class="w">
</span><span class="w">        </span><span class="k">active</span><span class="p">:</span><span class="w">              </span>&lt;-- must<span class="w"> </span>exist<span class="w">
</span><span class="w">            </span><span class="k">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="k">kubeletConfigKey</span><span class="p">:</span><span class="w"> </span>kubelet<span class="w">
</span><span class="w">                </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>node-config<span class="w"> 
</span><span class="w">                </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">                </span><span class="k">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024519&#34;</span><span class="w">
</span><span class="w">                </span><span class="k">uid</span><span class="p">:</span><span class="w"> </span>a8b4da9d-0b6e-478d<span class="m">-9e35</span>-4a3696f5778c<span class="w">
</span><span class="w">        </span><span class="k">assigned</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="k">kubeletConfigKey</span><span class="p">:</span><span class="w"> </span>kubelet<span class="w">
</span><span class="w">                </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>node-config<span class="w"> 
</span><span class="w">                </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">                </span><span class="k">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024519&#34;</span><span class="w">
</span><span class="w">                </span><span class="k">uid</span><span class="p">:</span><span class="w"> </span>a8b4da9d-0b6e-478d<span class="m">-9e35</span>-4a3696f5778c<span class="w">
</span><span class="w">        </span><span class="k">lastKnownGood</span><span class="p">:</span><span class="w">
</span><span class="w">            </span><span class="k">configMap</span><span class="p">:</span><span class="w">
</span><span class="w">                </span><span class="k">kubeletConfigKey</span><span class="p">:</span><span class="w"> </span>kubelet<span class="w">
</span><span class="w">                </span><span class="k">name</span><span class="p">:</span><span class="w"> </span>node-config<span class="w"> 
</span><span class="w">                </span><span class="k">namespace</span><span class="p">:</span><span class="w"> </span>default<span class="w">
</span><span class="w">                </span><span class="k">resourceVersion</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1024519&#34;</span><span class="w">
</span><span class="w">                </span><span class="k">uid</span><span class="p">:</span><span class="w"> </span>a8b4da9d-0b6e-478d<span class="m">-9e35</span>-4a3696f5778c<span class="w">
</span></code></pre></div><p>You must check that <code>status.conditions.active</code> fields exist, <strong>and</strong> there is no error field in <code>status.conditions.assigned</code>. If an error occured when applying the specified configuration, the Kubelet restarts with <code>status.conditions.lastKnownGood</code> config hence <code>status.conditions.active.configMap.resourceVersion</code> may different from that in <code>status.conditions.assigned</code>.</p>
<p>If an error occured, a systemd journal log indicates what would be an error:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1">## This error is logged when you missed data.kubelet.kind.</span>
Aug <span class="m">24</span> 13:16:04 localhost.worker kubelet<span class="o">[</span>278409<span class="o">]</span>: E0824 13:16:04.368361  <span class="m">278409</span> controller.go:151<span class="o">]</span> kubelet config controller: failed to load config, see Kubelet log <span class="k">for</span> details, error: failed to decode: Object <span class="s1">&#39;Kind&#39;</span> is missing in <span class="err">&#39;</span><span class="o">{</span>
</code></pre></div><p>Also, my configuration contains resource restriction; it is applied as intended:</p>
<div class="highlight"><pre class="chroma"><code class="language-yaml" data-lang="yaml">$<span class="w"> </span>kubectl<span class="w"> </span>get<span class="w"> </span>nodes<span class="w"> </span>${NODE_NAME}<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w">
</span><span class="w"></span><span class="k">status</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="k">allocatable</span><span class="p">:</span><span class="w">    
</span><span class="w">        </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">ephemeral-storage</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;66100978374&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">hugepages-1Gi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">hugepages-2Mi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>4775280Ki<span class="w">
</span><span class="w">        </span><span class="k">pods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;110&#34;</span><span class="w">
</span><span class="w">    </span><span class="k">capacity</span><span class="p">:</span><span class="w">
</span><span class="w">        </span><span class="k">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;4&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">ephemeral-storage</span><span class="p">:</span><span class="w"> </span>71724152Ki<span class="w">
</span><span class="w">        </span><span class="k">hugepages-1Gi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">hugepages-2Mi</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;0&#34;</span><span class="w">
</span><span class="w">        </span><span class="k">memory</span><span class="p">:</span><span class="w"> </span>8023408Ki<span class="w">
</span><span class="w">        </span><span class="k">pods</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;110&#34;</span><span class="w">
</span></code></pre></div><h2 id="authentication-and-authorization">Authentication and Authorization<a href="#authentication-and-authorization" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h2>
<p>During the setup, the Kubelet queries a ConfigMap object from the apiserver, which requires authentication.
According to <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, the node authorizer now <em>automatically</em> configures an RBAC rules so that there is nothing to do.</p>
<blockquote>
<p>Previously, you were required to manually create RBAC rules to allow Nodes to access their assigned ConfigMaps. The Node Authorizer now automatically configures these rules.</p>
</blockquote>
<p>Node authorizor means that default authorization mode contains <code>Node</code> ^[node-auth]:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">ps -ef <span class="p">|</span> grep kube-apiserver
root       <span class="m">91113</span>   <span class="m">91100</span>  <span class="m">2</span> Aug19 ?        02:29:37 kube-apiserver ... --authorization-mode<span class="o">=</span>Node,RBAC
</code></pre></div><p>so that any users in the <code>system:nodes</code> group (username <code>system:node:&lt;nodeName&gt;</code>) are allowed to:</p>
<ol>
<li>read services, endpoints, nodes, pods, secrets, configmaps, and persistent volumes (bound to the Kubelet&rsquo;s node)</li>
<li>write nodes (+status), pods (+status), and events.</li>
</ol>
<p>Dynamic Kubelet configuration requires permission for (1) read configmaps, and (2) write node status.</p>
<blockquote>
<p>Note that getting an object and listing objects are different. <code>kubectl get configmaps node-config</code> should be allowed, while <code>kubectl get configmaps</code> (get all configmaps, which means listing configmaps) are still denied.</p>
</blockquote>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://kubernetes.io/docs/tasks/administer-cluster/reconfigure-kubelet/">Kubernetes: Reconfigure a Node&rsquo;s Kubelet in a Live Cluster</a> <a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2" role="doc-endnote">
<p><a href="https://kubernetes.cn/docs/reference/command-line-tools-reference/feature-gates/">Kubernetes: Feature Gates</a> <a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

			</div>
		</article>

		<hr class="post-end">
		<footer class="post-info">
			<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather"><path d="M20.24 12.24a6 6 0 0 0-8.49-8.49L5 10.5V19h8.5z"></path><line x1="16" y1="8" x2="2" y2="22"></line><line x1="17.5" y1="15" x2="9" y2="15"></line></svg>Insu Jang</p>
			<p>
				<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://insujang.github.io/tags/study">study</a></span><span class="tag"><a href="https://insujang.github.io/tags/kubernetes">kubernetes</a></span>
			</p>
		</footer>
		
		<div id="comments" class="thin">

<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'insujang';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2017 - 2020 <a href="https://insujang.github.io">Insu Jang</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a>
		</p>
	</footer>



	<script src="https://insujang.github.io/js/bundle.min.5f369e6154ffc448cde6aa4d122cfa9ab2adfb150d7c88b27c8a61ede44126a2.js" integrity="sha256-XzaeYVT/xEjN5qpNEiz6mrKt+xUNfIiyfIph7eRBJqI=" crossorigin="anonymous"></script>
	
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-158110335-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
